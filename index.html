<!DOCTYPE html>
<html lang="en">
<head>
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
<script src="auth.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GlassHorses - Horse Breeding Sim</title>
  <link rel="stylesheet" href="styles.css">
  <script>
    // Track script loading state
    window.appLoaded = false;
    window.scriptsLoaded = {
      config: false,
      auth: false,
      drive: false,
      gallery: false,
      app: false
    };
    
    function checkAllScriptsLoaded() {
      const allLoaded = Object.values(window.scriptsLoaded).every(loaded => loaded);
      if (allLoaded) {
        window.appLoaded = true;
        console.log('âœ… All scripts loaded successfully');
        
        // Dispatch custom event when all scripts are loaded
        document.dispatchEvent(new CustomEvent('allScriptsLoaded'));
      }
    }
    
    // Error handler for script loading
    function handleScriptError(scriptName) {
      console.error(`âŒ Failed to load script: ${scriptName}`);
      window.scriptsLoaded[scriptName] = true; // Mark as loaded to prevent hangs
      checkAllScriptsLoaded();
      
      // Show error to user
      setTimeout(() => {
        const galleryEl = document.getElementById('gallery-list');
        if (galleryEl && !window.appLoaded) {
          galleryEl.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #e74c3c;">
              <h3>Script Loading Error</h3>
              <p>Failed to load ${scriptName}.js. Please refresh the page.</p>
              <button onclick="window.location.reload()">ğŸ”„ Refresh Page</button>
            </div>
          `;
        }
      }, 1000);
    }
  </script>
</head>
<body>
  <header>
    <h1>ğŸ GlassHorses</h1>
    <p>Horse Breeding Simulator with Community Gallery</p>
  </header>

  <nav>
    <button id="authorize_button" style="display:none">Authorize Drive</button>
<button id="signout_button" style="display:none">Sign Out</button>
<button id="drive-test-btn" style="display:none">Create Player Save</button>
<span id="user-name">Not logged in</span>
<div id="drive-status"></div>
<pre id="content"></pre>


    <span id="user-name">Not logged in</span>
  </nav>

  <main>
    <section id="single-player" class="section">
      <h2>ğŸ‡ Single Player Stable</h2>
      <p>Your personal horse breeding game (local + Google Drive saves).</p>
      <button id="drive-test-btn">ğŸ—„ï¸ Test Drive Save (Create Folder + test.md)</button>
      <button id="breed-btn">ğŸ´ Breed Horses</button>
      <div id="drive-status"></div>
      <div id="drive-debug" style="display: none; margin-top: 10px; font-size: 0.8em; color: #7f8c8d;"></div>
    </section>

    <section id="community-gallery" class="section">
      <h2>ğŸŒŸ Community Gallery</h2>
      <div id="gallery-list">Loading gallery...</div>
    </section>
  </main>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Application Scripts - CRITICAL ORDER with error handling -->
  <script src="config.js" onload="window.scriptsLoaded.config = true; checkAllScriptsLoaded();" 
          onerror="handleScriptError('config')"></script>
  <script src="auth.js" onload="window.scriptsLoaded.auth = true; checkAllScriptsLoaded();" 
          onerror="handleScriptError('auth')"></script>
  <script src="drive.js" onload="window.scriptsLoaded.drive = true; checkAllScriptsLoaded();" 
          onerror="handleScriptError('drive')"></script>
  <script src="gallery.js" onload="window.scriptsLoaded.gallery = true; checkAllScriptsLoaded();" 
          onerror="handleScriptError('gallery')"></script>
  <script src="app.js" onload="window.scriptsLoaded.app = true; checkAllScriptsLoaded();" 
          onerror="handleScriptError('app')"></script>
  
  <!-- Debug button (remove in production) -->
  <div style="position: fixed; bottom: 10px; right: 10px; z-index: 1000;">
    <button onclick="
      const debug = document.getElementById('drive-debug');
      debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
      debug.innerHTML = `
        <strong>Drive Status:</strong><br>
        App Loaded: ${window.appLoaded}<br>
        createPlayerSaveFolder: ${typeof window.createPlayerSaveFolder}<br>
        gapi: ${typeof window.gapi}<br>
        gapiInited: ${window.gapiInited}<br>
        Scripts: ${JSON.stringify(window.scriptsLoaded)}
      `;
    " style="font-size: 0.7em; padding: 5px;">ğŸ› Debug</button>
  </div>
</body>
</html>